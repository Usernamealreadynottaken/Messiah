{% extends "Hotel/base.html" %}

{% load staticfiles %}

{% block title %}Hotel Messiah - Rezerwacje{% endblock %}

{% block content %}

<div id="reservations">

    <div class="title">
        <h1>Rezerwacje</h1>
    </div> <!-- .title -->

    <div class="reservations-content">

        <div class="code">
            <label>Jesli chcesz edytowac istniejaca rezerwacje, podaj swoj kod rezerwacji:</label>
            <input type="text" class="code-input" name="code-input"
                    {% if rezerwacja_do_edycji %} value="{{ rezerwacja_do_edycji.kod }}"{% endif %}>
            <a class="code-send">Wyslij</a>
            <p class="code-error"></p>
        </div> <!-- .code -->

        <form action="{% url 'hotel:rezerwacje_wyslij' %}" method="post" class="resform">
            {% csrf_token %}

            <table>
                <tr>
                    <td>Imie i nazwisko:</td>
                    <td colspan="3"><input type="text" name="name"
                            {% if rezerwacja_do_edycji %} value="{{ rezerwacja_do_edycji.nazwisko }}"{% endif %}
                            required autofocus></td>
                </tr>
                <tr class="error-row">
                    <td colspan="4"><p class="name-error">Pole nie moze byc puste.</p></td>
                </tr>
                <tr>
                    <td>Telefon:</td>
                    <td colspan="3"><input type="tel" name="tel"
                            {% if rezerwacja_do_edycji %} value="{{ rezerwacja_do_edycji.telefon }}"{% endif %}></td>
                </tr>
                <tr>
                    <td>E-mail:</td>
                    <td colspan="3"><input type="email" name="email" placeholder="email@example.com"
                            {% if rezerwacja_do_edycji %} value="{{ rezerwacja_do_edycji.email }}"{% endif %}
                            required></td>
                </tr>
                <tr class="error-row">
                    <td colspan="4"><p class="email-error">Email musi byc w formacie local@domain</p></td>
                </tr>
                <tr>
                    <td>Poczatek pobytu:</td>
                    <td colspan="3"><input class="date-from" type="text" name="date-from"
                            {% if poczatek_pobytu %}
                            value="{{ poczatek_pobytu }}"
                            {% endif %}
                            required></td>
                </tr>
                <tr class="error-row">
                    <td colspan="4"><p class="dateFrom-error"></p></td>
                </tr>
                <tr>
                    <td>Koniec pobytu:</td>
                    <td colspan="3"><input class="date-to" type="text" name="date-to"
                            {% if koniec_pobytu %} value="{{ koniec_pobytu }}"{% endif %}
                            required></td>
                </tr>
                <tr class="error-row">
                    <td colspan="4"><p class="dateTo-error"></p></td>
                </tr>
                <tr>
                    <td>Liczba pokoi:</td>
                    <td colspan="3">
                        <select class="rooms" name="rooms">
                            <option value="1">1 Pokoj</option>
                            <option value="2">2 Pokoje</option>
                            <option value="3">3 Pokoje</option>
                        </select>
                    </td>
                </tr>
                <tr class="room1">
                    <td>Pokoj 1 - Dorosli:</td>
                    <td>
                        <select class="adults1" name="adults1">
                            <option value="0">0</option>
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </td>
                    <td>Dzieci:</td>
                    <td>
                        <select class="kids1" name="kids1">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </td>
                </tr>
                <tr class="room2">
                    <td>Pokoj 2 - Dorosli:</td>
                    <td>
                        <select class="adults2" name="adults2">
                            <option value="0">0</option>
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </td>
                    <td>Dzieci:</td>
                    <td>
                        <select class="kids2" name="kids2">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </td>
                </tr>
                <tr class="room3">
                    <td>Pokoj 3 - Dorosli:</td>
                    <td>
                        <select class="adults3" name="adults3">
                            <option value="0">0</option>
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </td>
                    <td>Dzieci:</td>
                    <td>
                        <select class="kids3" name="kids3">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </td>
                </tr>
            </table>

            <div class="calendars">
                <div class="calendar-from">
                    <p>Wybierz date przyjazdu</p>
                    <div class="datepicker-from"></div>
                </div>
                <div class="calendar-to">
                    <p>Wybierz date wyjazdu</p>
                    <div class="datepicker-to"></div>
                </div>

            </div> <!-- .calendars -->

            <!-- w error jest wyswietlany wynik powyzszego zapytania w formie w miare user friendly -->
            <p class="error"></p>

            {% if uslugi_all %}
            <div class="additions">
                <h2>Wybierz dodatki
                    <img src="{% static 'Hotel/img/arrow.png' %}" alt="arrow"/></h2>

                {% if uslugi_wewnetrzne %}
                <div class="in">
                    <h3>Uslugi wewnetrze: </h3>
                    <ul>
                        {% for usluga in uslugi_wewnetrzne %}
                        <label>
                            <input type="checkbox" name="in{{ forloop.counter }}" value="{{ usluga.pk }}"
                                    {% if usluga.pk in uslugi %} checked{% endif %}> {{ usluga.nazwa }}
                        </label><br>
                        {% endfor %}
                    </ul>
                </div> <!-- .in -->
                {% endif %} {# if uslugi_wewnetrzne #}

                {% if uslugi_zewnetrzne %}
                <div class="out">
                    <h3>Uslugi zewnetrzne: </h3>
                    <ul>
                        {% for usluga in uslugi_zewnetrzne %}
                        <label>
                            <input type="checkbox" name="out{{ forloop.counter }}" value="{{ usluga.pk }}"
                                    {% if usluga.pk in uslugi %} checked{% endif %}> {{ usluga.nazwa }}
                        </label><br>
                        {% endfor %}
                    </ul>
                </div> <!-- .out -->
                {% endif %} {# if uslugi_zewnetrzne #}

            </div> <!-- .additions -->
            {% endif %} {# if uslugi_all #}

            <div class="summary">
                <h3>Twoje zyczenia</h3>
                <textarea name="requests" rows="4" cols="50">{% if rezerwacja_do_edycji %}{{ rezerwacja_do_edycji.dodatkowe_instrukcje }}{% endif %}</textarea>
                <p>Cena pobytu za wynajem <span class="NoRooms">x</span>
                    pokoi na <span class="NoNights">y</span> nocy:
                    <span class="price">1</span> </p>
                <a class="send">Zarezerwuj</a>
            </div> <!-- .summary -->

        </form>

    </div> <!-- .reservations-content -->

</div> <!-- .reservations -->

{% endblock %}

{% block scripts %}

<script src="{% static 'Hotel/js/jquery.form.js' %}"></script>
<script src="{% static 'Hotel/js/rezerwacje.js' %}"></script>

<script>

function sprawdzPoprawnosc() {
    var currentDate = new Date();
    currentDate.setDate(currentDate.getDate() -1);
    var days = $(".date-from").val().substring(3,5);
    var months = $(".date-from").val().substring(0, 2) - 1;
    var years = $(".date-from").val().substring(6);
    var dateFrom = new Date(years, months, days);
    var inputFrom = $(".date-from").val();
    if (validateDate(inputFrom, ".dateFrom-error") && currentDate < dateFrom) {
        $(".date-from").parent().removeClass("negative-input");
        $(".date-from").parent().addClass("positive-input");
        $(".dateFrom-error").animate({
            "height": "0",
        });
		        var days = $(".date-to").val().substring(3,5);
        var months = $(".date-to").val().substring(0, 2) - 1;
        var years = $(".date-to").val().substring(6);
        var dateTo = new Date(years, months, days);
        var inputTo = $(".date-to").val();
        if (validateDate(inputTo, ".dateTo-error") && dateFrom < dateTo) {
            $(".date-to").parent().removeClass("negative-input");
            $(".date-to").parent().addClass("positive-input");

            $(".dateTo-error").animate({
                "height": "0",
            });
    var toSend = {
            csrfdmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
            poczatekPobytu: $(".date-from").val(),
            koniecPobytu: $(".date-to").val(),
            iloscPokojow: $(".rooms").val(),
            dorosli1: $(".adults1").val(),
            dzieci1: $(".kids1").val(),
            dorosli2: $(".adults2").val(),
            dzieci2: $(".kids2").val(),
            dorosli3: $(".adults3").val(),
            dzieci3: $(".kids3").val(){% if rezerwacja_do_edycji %},
            kod: "{{ rezerwacja_do_edycji.kod }}"{% else %},
            kod: ""{% endif %}
        };
    $.ajax({
        type: "GET",
        // dataType: "html",
        url: "{% url 'hotel:rezerwacje_sprawdz' %}",
        data: toSend
    })
        .done(function(data) {
            var parsed = $.parseJSON(data);







                    // Patrzymy na tyle pokojow ile mamy zaznaczone i czy sa tam liczby
                    var error = "";
                    for ( var i = 1; i <= $(".rooms").val(); i++ ) {
                        var cur_pokoj = "pokoj" + i
                        if (parsed[cur_pokoj]) {
                            if (!$.isNumeric(parsed[cur_pokoj])) {

                                // Jesli w otrzymanym JSONie pod haslem 'pokojN' nie ma liczby (pk pokoju)
                                // to znaczy ze jest jakis blad, wiec wypisujemy stosowny message
                                if (parsed[cur_pokoj] == "not_checked") {
                                    error += "Pokoj " + i + " nie zostal zweryfikowany przez serwer.<br />";
                                } else if (parsed[cur_pokoj] == "zero_selected") {
                                    error += "W pokoju nr " + i + " jest wybrane 0 osob.<br />";
                                } else if (parsed[cur_pokoj] == "over_max_capacity") {
                                    error += "Pokoj " + i + " - za duzo osob.<br />";
                                } else if (parsed[cur_pokoj] == "no_free_rooms") {
                                    error += "Pokoj " + i + " - brak wolnych pokojow.<br />";
                                } else {
                                    error += "Wystapil blad ktory powinien nie istniec.<br />";
                                }

                            }

                        } else {
                            // Mimo zaznaczonej ilosci pokojow z jakiegos powodu nie dostalismy w ogole
                            // informacji o n-tym pokoju od serwera
                            error += "Pokoj " + i + " - blad po stronie serwera.<br />"
                        }
                    }

                    // Jesli byly bledy zwiazane z jakims pokojem to wypisujemy na stronie
                    $(".error").html(error);
                })
                .fail(function(xhr, textStatus, errorThrown) {
                    alert("Error: " + errorThrown + xhr.status + xhr.responseText);
                });
        } else {
            $(".date-to").parent().removeClass("positive-input");
            $(".date-to").parent().addClass("negative-input");
            if ($(".dateTo-error").text() == "") {
                $(".dateTo-error").text("Za wczesna data wyjazdu.");
            }
            $(".dateTo-error").animate({
                "height": "28px",
            });
        }
    } else {
        $(".date-from").parent().removeClass("positive-input");
        $(".date-from").parent().addClass("negative-input");
        if ($(".dateFrom-error").text() == "") {
            $(".dateFrom-error").text("Za wczesna data przyjazdu.");
        }
        $(".dateFrom-error").animate({
            "height": "28px",
        });
    }
}

$(".code-send").click(function() {
    if ($(".code-input").val().length == 0) {
        $(".code-error").text("Nie podano kodu.");
    } else {
        $(".code-error").text("");

        // Wysylamy ajaxa sprawdzajacego czy podany rezerwacja o podanym kodzie w ogole istnieje zeby
        // nie przekierowywac bez sensu uzytkownika na strone z nieistniejaca rezerwacja (czyli do 404)
        var toSend = {
            csrfdmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
            code: $(".code-input").val()
        };
        $.ajax({
            type: "GET",
            url: "{% url 'hotel:rezerwacje_sprawdz' %}" + $(".code-input").val() + "/",
            data: toSend
        })
            .done(function(data) {
                if (data == "true") {

                    // Jesli rezerwacja o podanym kodzie istnieje to wczytujemy ja, tzn. przechodzimy
                    // do odpowiedniego url
                    window.location = "{% url 'hotel:rezerwacje' %}" + $(".code-input").val() + "/";

                } else {
                    $(".code-error").text("Rezerwacja o podanym kodzie nie istnieje.");
                }
            })
            .fail(function(xhr, textStatus, errorThrown) {
                alert("Error: " + errorThrown + xhr.status + xhr.responseText);
            });
    }
})

$(".send").click(function() {
    var currentDate = new Date();
    currentDate.setDate(currentDate.getDate() -1);
    var days = $(".datepicker-from").datepicker("getDate").getDate();
    var months = $(".datepicker-from").datepicker("getDate").getMonth();
    var years = $(".datepicker-from").datepicker("getDate").getFullYear();
    var dateFrom = new Date(years, months, days);
    if (currentDate < dateFrom) {
        days = $(".datepicker-to").datepicker("getDate").getDate();
        months = $(".datepicker-to").datepicker("getDate").getMonth();
        years = $(".datepicker-to").datepicker("getDate").getFullYear();
        var dateTo = new Date(years, months, days);
        if (dateFrom <= dateTo) {

            {% if rezerwacja_do_edycji %}
            $("form").ajaxForm(function(data) {
                alert(data);
            });

            {% else %}
            $("form").ajaxForm(function(data) {
                var parsed = $.parseJSON(data);

                if (parsed["message"] && parsed["message"] == "success") {
                    if (parsed["kod"]) {
                        $(".success").html("Udalo sie zarezerwowac!<br /><br >Twoj kod rezerwacji to: " + parsed["kod"]);
                    } else {
                        $(".success").html("Udalo sie zarezerwowac!<br /><br >Serwer nie wyslal kodu rezerwacji!");
                    }
                } else if (parsed["message"] && parsed["message"] == "validation_error") {
                    $(".success").html("Nie mozna zarezerwowac tego pokoju na ten termin.");
                } else if (parsed["message"] && parsed["message"] == "site_error") {
                    $(".success").html("Serwer otrzymal uszkodzone dane.");
                } else {
                    $(".success").html("Stalo sie cos czego nawet programista nie przewidzial.");
                }
            });
            {% endif %}
            $("form").submit();

        } else {
            $(".success").html("Bledne daty!");
        }
    } else {
        $(".success").html("Za wczesna data poczatkowa!");
    }
})

{% if liczba_pokoi or uslugi or rezerwacja_do_edycji %}
$(document).ready(function() {
    $(".rooms").val("{{ liczba_pokoi }}").trigger("change");

    {% if uslugi %}
    $(".additions h2").trigger("click");
    {% endif %}

    {% if doroslych1 %}
    $(".adults1").val("{{ doroslych1 }}");
    {% else %}
    $(".adults1").val("0");
    {% endif %}

    {% if doroslych2 %}
    $(".adults2").val("{{ doroslych2 }}");
    {% else %}
    $(".adults2").val("0");
    {% endif %}

    {% if doroslych3 %}
    $(".adults3").val("{{ doroslych3 }}");
    {% else %}
    $(".adults3").val("0");
    {% endif %}

    {% if dzieci1 %}
    $(".kids1").val("{{ dzieci1 }}");
    {% else %}
    $(".kids1").val("0");
    {% endif %}

    {% if dzieci2 %}
    $(".kids2").val("{{ dzieci2 }}");
    {% else %}
    $(".kids2").val("0");
    {% endif %}

    {% if dzieci3 %}
    $(".kids3").val("{{ dzieci3 }}");
    {% else %}
    $(".kids3").val("0");
    {% endif %}

    {% if rezerwacja_do_edycji %}
    $("form").attr("action", "{% url 'hotel:rezerwacje_wyslij' %}" + "{{ rezerwacja_do_edycji.kod }}" + "/");
    {% endif %}
})
{% endif %}

$(".date-from").focusout(function() {
    sprawdzPoprawnosc();
});

$(".date-to").focusout(function() {
    sprawdzPoprawnosc();
});

$(".datepicker-from").datepicker({
    onSelect: function() {
        sprawdzPoprawnosc();
    },
    altField: ".date-from",
});
$(".datepicker-to").datepicker({
    onSelect: function() {
        sprawdzPoprawnosc();
    },
    altField: ".date-to",
});

</script>

{% endblock %}